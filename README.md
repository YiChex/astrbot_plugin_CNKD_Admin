# 敏感词监控插件（优化修复版）

## 简介

这是一个AstrBot敏感词监控插件，用于自动检测和处理QQ群聊中的敏感词。支持本地检查和远程API检查，具备自动删除消息、自动禁言等功能。

**版本**: 2.1.0  
**作者**: AstrBot  
**插件ID**: sensitive_word_monitor

## 主要功能

- **自动监控** - 自动检测群消息中的敏感词
- **智能检测** - 支持本地检查和远程API检查双引擎
- **自动处理** - 自动删除违规消息、自动禁言违规用户
- **分级禁言** - 根据违规次数自动提级禁言（60秒→10分钟→1天）
- **数据缓存** - 消息内容缓存，减少API调用
- **频率限制** - API调用频率限制器，防止过度调用
- **数据库记录** - 记录所有违规信息，支持数据分析
- **统计分析** - 详细的违规统计和数据报告

## 核心组件

### 1. LRUCache - 最近最少使用缓存
用于缓存频繁访问的数据，实现自动淘汰机制。
- 容量限制：1000条记录
- 线程安全

### 2. APIRateLimiter - API频率限制器
防止API调用过于频繁。
- 默认限制：60次/分钟，1000次/小时
- 自动冷却机制

### 3. MessageContentCache - 消息缓存管理
缓存已检查的消息内容。
- TTL：3600秒（可配置）
- 最大缓存：10000条（可配置）
- 自动过期清理

### 4. DatabaseConnectionPool - 数据库连接池
高效管理SQLite连接。
- 最大连接数：10
- 连接复用

### 5. RetryManager - 重试管理器
处理API请求失败的自动重试。
- 最大重试：3次
- 指数退避延迟：1-30秒

### 6. SensitiveWordAPIClient - 敏感词API客户端
调用远程API进行敏感词检查。
- 自动会话管理
- 内置超时控制
- 统计API调用

## 支持的指令

### 📌 API统计
**命令**: `API统计`  
**权限**: 仅管理员  
**说明**: 显示API调用的详细统计信息

**返回信息**:
```
📊 API调用统计
总调用次数: 150
成功调用: 145
失败调用: 5
缓存命中: 80
成功率: 96.7%

频率限制状态:
  当前分钟调用: 12/60
  当前小时调用: 456/1000
  冷却状态: 否
```

---

### 🔄 重置API限制
**命令**: `重置API限制`  
**权限**: 仅管理员  
**说明**: 重置API调用计数器，清除频率限制状态

**返回信息**:
```
✅ API调用计数已重置
- 分钟计数已清零
- 小时计数已清零
- 冷却状态已清除
```

---

### 🗑️ 清理缓存
**命令**: `清理缓存`  
**权限**: 仅管理员  
**说明**: 清除所有消息内容缓存

**返回信息**:
```
✅ 已清理 256 条消息缓存
下次检查将重新查询API
```

---

## 配置说明

### 基本配置
```json
{
  "group_whitelist": ["QQ:GroupMessage:1030157691"],
  "admin_qq_list": ["QQ:FriendMessage:475407353"],
  "api_endpoint": "https://uapis.cn/api/v1/text/profanitycheck",
  "enable_auto_ban": true,
  "enable_message_delete": true,
  "enable_local_check": true,
  "debug_mode": false
}
```

### API限制配置
```json
{
  "api_rate_limit": {
    "max_calls_per_minute": 60,
    "max_calls_per_hour": 1000
  }
}
```

### 缓存配置
```json
{
  "cache_config": {
    "cache_ttl": 3600,
    "max_cache_size": 10000
  }
}
```

### 重试配置
```json
{
  "retry_config": {
    "max_retries": 3,
    "base_delay": 1.0,
    "max_delay": 30.0
  }
}
```

### 禁言规则配置
```json
{
  "ban_rules": {
    "first_ban_duration": 60,
    "second_ban_duration": 600,
    "third_ban_duration": 86400,
    "reset_time": 4
  }
}
```

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| group_whitelist | 监控的白名单群聊 | 1030157691 |
| admin_qq_list | 管理员QQ列表 | 475407353 |
| api_endpoint | 敏感词检查API地址 | https://uapis.cn/api/v1/text/profanitycheck |
| enable_auto_ban | 是否启用自动禁言 | true |
| enable_message_delete | 是否启用自动删除消息 | true |
| enable_local_check | 是否启用本地检查 | true |
| debug_mode | 是否启用调试模式 | false |
| cooldown_seconds | 用户查询冷却时间 | 60 |
| max_log_days | 违规记录保留天数 | 30 |
| cache_ttl | 缓存过期时间（秒） | 3600 |
| max_cache_size | 最大缓存条目数 | 10000 |
| max_retries | 最大重试次数 | 3 |
| first_ban_duration | 首次禁言时长（秒） | 60 |
| second_ban_duration | 第二次禁言时长（秒） | 600 |
| third_ban_duration | 第三次禁言时长（秒） | 86400 |

## 工作流程

1. **接收消息** - 监控配置的白名单群聊消息
2. **本地检查** - 使用本地自定义违禁词检查
3. **API检查** - 调用远程API进行深度检查
4. **频率控制** - 检查API调用是否超过限制
5. **缓存检查** - 查询消息缓存，避免重复检查
6. **检查结果**:
   - ✅ 无敏感词 - 消息通过，不做处理
   - ⚠️ 检测到敏感词 - 执行以下操作：
     - 删除消息
     - 更新违规记录
     - 查询用户违规次数
     - 根据次数自动禁言
     - 发送管理员通知

## 禁言规则

| 违规次数 | 禁言时长 | 说明 |
|---------|---------|------|
| 第1次 | 60秒 | 首次警告 |
| 第2次 | 10分钟 | 第二次警告 |
| 第3次 | 1天 | 严厉处罚 |

**重置机制**: 距离上次违规超过4小时，计数重置为0

## 数据库

### 违规记录表
存储路径: `data/plugin_data/sensitive_word_monitor/violations.db`

记录字段:
- 群聊ID
- 用户ID
- 用户昵称
- 违规内容
- 检测到的敏感词
- 禁言时长
- 违规时间

自动清理: 超过30天的记录自动删除

## 性能优化

- **消息缓存** - 避免重复检查相同消息（MD5指纹）
- **连接池** - 复用数据库连接减少开销
- **频率限制** - 防止API滥用
- **异步处理** - 非阻塞式API调用
- **定期清理** - 自动清理过期数据

## 日志输出

插件启动时输出:
```
============================================================
敏感词监控插件 v2.1.0 已加载（已修复API调用问题）
监控群聊：1个
管理员：1个
自定义违禁词：5个
API调用限制：60/分钟，1000/小时
消息缓存：TTL=3600秒，最大大小=10000
重试策略：最大3次，退避延迟1.0-30.0秒
============================================================
```

运行时日志包含:
- 消息检查日志
- API请求和响应
- 缓存命中情况
- 违规处理结果
- 禁言事件
- 错误和异常

## 常见问题

**Q: 为什么某些敏感词没有被检测到？**
A: 
1. 检查本地自定义违禁词列表是否包含
2. 检查API是否正常工作
3. 检查本地检查是否启用

**Q: API调用太频繁导致限流怎么办？**
A:
1. 使用"重置API限制"命令清除限流状态
2. 增加cache_timeout值，缓存更长时间
3. 降低max_calls_per_minute设置

**Q: 如何查看违规记录？**
A: 违规记录存储在SQLite数据库中，可使用SQL工具查询violations.db

**Q: 调试模式有什么作用？**
A: 启用调试模式可看到详细日志，便于排查问题

## 许可证

详见LICENSE文件
